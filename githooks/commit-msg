#!/bin/bash
#
# Commit message hook for Neuro-Engine
# Ensures commits touching engine layers are properly tagged
#
# Install: git config core.hooksPath githooks
#

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
YELLOW='\033[1;33m'
NC='\033[0m'

# Protected paths
PROTECTED_PATHS=(
    "Packages/com.neuroengine.core/Runtime/Core/"
    "Packages/com.neuroengine.core/Runtime/Services/"
    "Packages/com.neuroengine.core/Editor/"
    "Packages/com.neuroengine.core/Tests/"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if any protected paths are affected
AFFECTED_LAYERS=()
for file in $STAGED_FILES; do
    # Layer 1: Core interfaces and lifetime scope
    if [[ "$file" == *"Runtime/Core/NeuroEngineLifetimeScope"* ]] || [[ "$file" == *"Runtime/Core/I"*".cs" ]]; then
        if [[ ! " ${AFFECTED_LAYERS[@]} " =~ " L1 " ]]; then
            AFFECTED_LAYERS+=("L1")
        fi
    fi

    # Layer 2: Observation services
    if [[ "$file" == *"Capture"* ]] || [[ "$file" == *"Detector"* ]] || [[ "$file" == *"Analysis"* ]] || [[ "$file" == *"Accessibility"* ]]; then
        if [[ ! " ${AFFECTED_LAYERS[@]} " =~ " L2 " ]]; then
            AFFECTED_LAYERS+=("L2")
        fi
    fi

    # Layer 3: Interaction services
    if [[ "$file" == *"InputSimulation"* ]] || [[ "$file" == *"Interaction"* ]]; then
        if [[ ! " ${AFFECTED_LAYERS[@]} " =~ " L3 " ]]; then
            AFFECTED_LAYERS+=("L3")
        fi
    fi

    # Layer 4: Persistence services
    if [[ "$file" == *"Writer"* ]] || [[ "$file" == *"TaskManager"* ]] || [[ "$file" == *"Transcript"* ]]; then
        if [[ ! " ${AFFECTED_LAYERS[@]} " =~ " L4 " ]]; then
            AFFECTED_LAYERS+=("L4")
        fi
    fi

    # Layer 5: Evaluation/Validation
    if [[ "$file" == *"Validation"* ]] || [[ "$file" == *"Evaluator"* ]]; then
        if [[ ! " ${AFFECTED_LAYERS[@]} " =~ " L5 " ]]; then
            AFFECTED_LAYERS+=("L5")
        fi
    fi

    # Tests
    if [[ "$file" == *"/Tests/"* ]]; then
        if [[ ! " ${AFFECTED_LAYERS[@]} " =~ " tests " ]]; then
            AFFECTED_LAYERS+=("tests")
        fi
    fi
done

# If layers affected, suggest adding layer tags to commit message
if [ ${#AFFECTED_LAYERS[@]} -gt 0 ]; then
    LAYER_TAGS=$(IFS=,; echo "${AFFECTED_LAYERS[*]}")

    # Check if commit message already has layer tags
    if [[ ! "$COMMIT_MSG" =~ \[L[0-9]\] ]] && [[ ! "$COMMIT_MSG" =~ \[tests\] ]]; then
        echo -e "${YELLOW}TIP: This commit affects engine layers: $LAYER_TAGS${NC}"
        echo -e "${YELLOW}Consider prefixing your commit message with layer tags.${NC}"
        echo ""
        echo -e "Example: [${LAYER_TAGS}] Your commit message"
        echo ""
    fi
fi

exit 0
